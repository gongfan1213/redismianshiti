### 第5章 Redis数据库
通过对前面章节的学习，我们熟悉了Redis数据库的键命令，本章将为大家讲解Redis数据库。使用前面章节讲到的命令来操作Redis数据库，比如，切换Redis数据库，Redis数据库中的键操作（添加、更新、删除、取值等），以及Redis数据库高版本（Redis 2.8）中的通知功能等。

#### 5.1 Redis数据库切换
Redis数据库保存在Redis服务器状态server.h/redisServer结构的db数组中。这个db数组中的每个元素都是一个server.h/redisDb结构，而每个redisDb结构就代表一个Redis数据库。

Redis服务器状态有一个dbnum属性，该属性用于在启动Redis服务器时，决定创建多少个数据库。Redis服务器配置中的database选项决定了dbnum属性的值。在默认情况下，dbnum属性的值为16，也就是在启动Redis服务器时，会默认创建16（0~15号）个数据库，如图5.1所示。

![image](https://github.com/user-attachments/assets/067e29b0-99d2-494a-8301-f6739451cc39)


**图5.1 Redis数据库**

```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__...
          |__ db[14]
          |__ db[15]
    |
    |__ dbnum 16
```

我们在操作数据库时，需要选择具体操作哪个数据库。每个Redis客户端都有其对应的目标数据库，在利用Redis客户端操作数据库时，目标数据库就是操作对象。通常，我们在操作Redis数据库时，默认操作的是Redis的0号数据库。如果我们想操作其他数据库，则可以使用SELECT命令来切换数据库，比如切换到4号数据库，操作如图5.2所示。

![image](https://github.com/user-attachments/assets/c41cf5ca-1fdc-4b00-a27a-79437840c6a6)


**图5.2 使用SELECT命令切换数据库**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__ db[3]
          |__ db[4]
          |__...
          |__ db[15]
    |
    |__ dbnum 16
redisClient
    |
    |__ db
          |__  (通过SELECT 4切换指向db[4])
```

在Redis服务器内部，有一个db属性，这个属性是客户端状态redisClient中的属性，它是一个指向redisDb结构的指针，用于记录当前客户端操作的目标数据库。redisClient.db指针指向redisServer.db数组中的某个元素，这个被指向的元素就是客户端的目标数据库。我们在启动Redis服务器与客户端时，默认的目标数据库是0号数据库，这个客户端指向的也是0号数据库，此时客户端与服务器状态之间的关系如图5.3所示。

![image](https://github.com/user-attachments/assets/469509e1-b53f-4bb6-9cf5-20d18727b9b3)


**图5.3 Redis客户端与服务器状态之间的关系**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__ db[3]
          |__...
          |__ db[15]
    |
    |__ dbnum 16
redisClient
    |
    |__ db
          |__ (默认指向0号数据库)
```

命令SELECT的实现原理：我们在操作Redis数据库时，可以根据需要使用SELECT index命令来切换当前操作的Redis数据库，这个index就相当于redisServer.db数组的下标，这个下标从0开始，它也是redisClient.db指针的索引值，索引值从0开始。通过指定index的值，也就是修改redisClient.db指针，来指向服务器中的不同数据库，达到切换数据库的目的。

#### 5.2 Redis数据库中的键操作
Redis是一个键值对数据库，在Redis服务器中使用server.h/redisDb结构来表示Redis数据库。在redisDb结构中存储了Redis数据库中的所有键值对，它就是dict字典，这个字典就是Redis的键空间。这个键空间存储了Redis数据库中的键和其对应的值，每个键就是一个字符串对象，而每个键所对应的值可以是字符串对象、集合对象、有序集合对象、列表对象或哈希表对象。

我们在操作Redis数据库时，比如，执行添加键、修改键、删除键或取键值操作，其实就是在操作Redis的键空间，这个键空间针对数据库的所有操作。下面我们来逐一说明。

##### 5.2.1 添加键
向Redis数据库中添加新键值对，其实就是将一个新键值对插入键空间字典里面，这个键是一个字符串对象，而这个值可以是Redis数据类型中的任意一种。比如，当前数据库是一个空数据库，我们向数据库中添加两个新的键值对，命令如下：
```
127.0.0.1:6379> SET name "liuhefei"
OK
127.0.0.1:6379> SET age 18
OK
```
再比如，执行如下命令来向键空间中添加新值：
```
127.0.0.1:6379> HSET chain city "北京"
OK
127.0.0.1:6379> HSET chain city "上海"
OK
```
在Redis中，除可以使用SET命令向Redis键空间中添加新的键值对以外，还有许多命令也可以实现添加新的键值对，读者可以参考第3章中的相关命令操作。

##### 5.2.2 修改键
在Redis中，修改Redis的键，其实就是对键空间里面的键所对应的值进行修改，这个值可以是Redis数据类型中的任意一种，因此对这个值的修改命令也会不同。

比如，之前我们已经向数据库中添加了一个键name，我们来修改它的值，执行以下命令：
```
127.0.0.1:6379>SET name "Hello redis"
OK
```
执行命令之后，name键所对应的由最初的“liuhefei”修改为“Hello redis”。

针对Redis键值对的值的数据类型不同，会有相对应的修改键命令，在此不再赘述，请读者参考第3章中的相关命令操作。

除可以修改Redis键所对应的值之外，还可以修改这个键的时间（生存时间或过期时间）。Redis有4个命令可以设置键的生存时间，分别是EXPIRE、PEXPIRE、EXPIREAT及PEXPIREAT。

使用EXPIRE命令来修改Redis键的生存时间，它以秒为单位；或者使用PEXPIRE命令来修改Redis键的生存时间，它以毫秒为单位。在经过指定的秒数或毫秒数（倒计时）之后，这个键对应的生存时间变为0，此时服务器会自动删除生存时间设置为0的键。如果要为一个字符串类型的键值对设置过期时间，则可以在使用SET命令设置一个字符串键的同时，为这个键设置过期时间。操作如下：
```
127.0.0.1:6379>SET height 170
OK
127.0.0.1:6379>EXPIRE height 10  //设置height键的生存时间为10秒
(integer) 1
127.0.0.1:6379>GET height  //10秒之内height键还存在
"170"
127.0.0.1:6379>GET height  //10秒之后，height键的生存时间为0，被删除
(nil)
```
同理，PEXPIRE命令也是如此。

与EXPIRE或PEXPIRE命令相似的还有EXPIREAT或PEXPIREAT命令，这两个命令分别以秒或毫秒精度来给数据库中的某个键设置过期时间，这个过期时间是UNIX时间戳，我们可以通过TIME命令来查看。当这个键的过期时间为0时，服务器会自动删除它。操作如下：
```
127.0.0.1:6379>SET width 100
OK
127.0.0.1:6379>EXPIREAT width 1527342900
(integer) 1
127.0.0.1:6379>TIME
1) "1527342821"
2) "504782"
127.0.0.1:6379>GET width  //UNIX时间戳之前
"170"
127.0.0.1:6379>TIME
1) "1527342912"
2) "657996"
127.0.0.1:6379>GET width
(nil)
```
另外，也可以使用TTL或PTTL命令来接收一个设置了生存时间的键，用于获取这个键的剩余生存时间，返回的剩余生存时间值就是距离服务器删除这个键的剩余时间。操作如下：
```
127.0.0.1:6379> SET key1 value1
OK
127.0.0.1:6379>EXPIRE key1 1000
(integer) 1
127.0.0.1:6379>TTL key1
(integer) 6379
```
上面的命令设置了很多键的生存时间，那么这些键的生存时间保存在哪里呢？ 


### 第5章 Redis数据库
通过对前面章节的学习，我们熟悉了Redis数据库的键命令，本章将为大家讲解Redis数据库。使用前面章节讲到的命令来操作Redis数据库，比如，切换Redis数据库，Redis数据库中的键操作（添加、更新、删除、取值等），以及Redis数据库高版本（Redis 2.8）中的通知功能等。

#### 5.1 Redis数据库切换
Redis数据库保存在Redis服务器状态server.h/redisServer结构的db数组中。这个db数组中的每个元素都是一个server.h/redisDb结构，而每个redisDb结构就代表一个Redis数据库。

Redis服务器状态有一个dbnum属性，该属性用于在启动Redis服务器时，决定创建多少个数据库。Redis服务器配置中的database选项决定了dbnum属性的值。在默认情况下，dbnum属性的值为16，也就是在启动Redis服务器时，会默认创建16（0 - 15号）个数据库。

我们在操作数据库时，需要选择具体操作哪个数据库。每个Redis客户端都有其对应的目标数据库，在利用Redis客户端操作数据库时，目标数据库就是操作对象。通常，我们在操作Redis数据库时，默认操作的是Redis的0号数据库。如果我们想操作其他数据库，则可以使用SELECT命令来切换数据库。

在Redis服务器内部，客户端状态redisClient中的db属性，是一个指向redisDb结构的指针，用于记录当前客户端操作的目标数据库。命令SELECT的实现原理是通过修改redisClient.db指针，来指向服务器中的不同数据库，达到切换数据库的目的。

#### 5.2 Redis数据库中的键操作
Redis是一个键值对数据库，在redisDb结构中存储了Redis数据库中的所有键值对，键空间存储了数据库中的键和其对应的值，值可以是多种对象类型。

##### 5.2.1 添加键
向Redis数据库中添加新键值对，即将新键值对插入键空间字典。可以使用SET、HSET等命令添加键值对，还有许多命令可实现添加操作。

示例：
```
127.0.0.1:6379> SET name "liuhefei"
OK
127.0.0.1:6379> SET age 18
OK
127.0.0.1:6379> HSET chain city "北京"
OK
127.0.0.1:6379> HSET chain city "上海"
OK
```

##### 5.2.2 修改键
修改Redis的键，即对键空间里键对应的值进行修改。值类型不同，修改命令也不同。除修改值外，还可修改键的生存时间或过期时间，有EXPIRE、PEXPIRE、EXPIREAT、PEXPIREAT等命令，也可使用TTL或PTTL命令获取键的剩余生存时间。

示例：
```
127.0.0.1:6379>SET name "Hello redis"
OK
127.0.0.1:6379>SET height 170
OK
127.0.0.1:6379>EXPIRE height 10  //设置height键的生存时间为10秒
(integer) 1
127.0.0.1:6379>GET height  //10秒之内height键还存在
"170"
127.0.0.1:6379>GET height  //10秒之后，height键的生存时间为0，被删除
(nil)
127.0.0.1:6379>SET width 100
OK
127.0.0.1:6379>EXPIREAT width 1527342900
(integer) 1
127.0.0.1:6379>TIME
1) "1527342821"
2) "504782"
127.0.0.1:6379>GET width  //UNIX时间戳之前
"170"
127.0.0.1:6379>TIME
1) "1527342912"
2) "657996"
127.0.0.1:6379>GET width
(nil)
127.0.0.1:6379> SET key1 value1
OK
127.0.0.1:6379>EXPIRE key1 1000
(integer) 1
127.0.0.1:6379>TTL key1
(integer) 6379
```
还可使用PERSIST命令删除键的生存时间。

示例：
```
127.0.0.1:6379>PEXPIREAT sms 1527349000  //设置sms键的生存时间
OK
127.0.0.1:6379>TTL sms  //获取sms键的剩余生存时间
(integer) 13876
127.0.0.1:6379>PERSIST sms  //删除sms键的生存时间
(integer) 1
127.0.0.1:6379>TTL sms  //返回-1，表示已经成功删除sms键的生存时间
(integer) -1
```

##### 5.2.3 删除键
使用DEL命令删除一个键。对于过期的键，有定时删除、惰性删除、定期删除三种删除方式：
- **定时删除**：在设置过期时间的同时设置定时器，过期时立即删除。优点是能及时释放内存，缺点是占用CPU资源，影响服务器性能。
- **惰性删除**：每次从键空间获取键时检查是否过期，过期则删除，不过期则返回。不主动消耗CPU检查无关过期键，但过期键会长期占用内存。
- **定期删除**：每隔一段时间对数据库进行检查，筛选并删除过期键，是定时删除和惰性删除的折中方案，减少CPU占用，及时释放过期键内存。

Redis服务器采用惰性删除和定期删除方式。惰性删除由db.c/expireIfNeeded函数实现，Redis读写命令会调用该函数检查输入键；定期删除由server.c/activeExpireCycle函数实现，Redis服务器周期性操作会调用此函数遍历数据库删除过期键。

示例：
```
127.0.0.1:6379>DEL name
(integer) 1
```

##### 5.2.4 取键值
从数据库键空间取出键对应的值，针对不同数据类型有不同取键值命令，取字符串类型键值用GET命令。

示例：
```
127.0.0.1:6379>SET news 你好! 我是redis!
OK
127.0.0.1:6379>GET news
"你好! 我是redis!"
```

#### 5.3 Redis数据库通知
Redis 2.8版本后新增数据库通知功能，可让客户端订阅消息频道或模式，动态获取数据库中键的变化及命令执行情况。

##### 5.3.1 数据库通知分类
- **键空间通知**：关注某个键执行了什么命令。使用SUBSCRIBE命令获取，如`127.0.0.1:6379>SUBSCRIBE __keyspace@1__:message` ，可接收对message键执行命令的通知。
- **键事件通知**：关注某个命令被哪些键执行。使用SUBSCRIBE命令，如`127.0.0.1:6379>SUBSCRIBE __keyevent@1__:set` ，可查看1号数据库中SET命令被哪些键执行。

键空间通知以`__keyspace@<db>__`为前缀，键事件通知以`__keyevent@<db>__`为前缀。默认数据库通知功能关闭，可通过CONFIG SET命令或修改redis.conf中notify - keyspace - events参数开启或关闭。该参数值规定服务器发送通知类型，常见参数值组合如：
- AKE：表示所有类型的通知都会被发送。
- AK：表示让服务器发送所有类型的键空间通知。
- AE：表示让服务器发送所有类型的键事件通知。
- KS：表示让服务器只发送与字符串键相关的键空间通知。
- El：表示让服务器只发送与列表键有关的键事件通知。 

##### 5.3.2 数据库通知的实现原理
数据库通知发送功能由notify.c/notifyKeyspaceEvent函数实现，函数定义为`void notifyKeyspaceEvent(int type, char *event, robj *key, int dbid);` ，各参数含义如下：
- type参数：表示要发送的通知类型，程序依此判断是否为服务器配置的通知类型，决定是否发送通知。
- event参数：表示发送事件的名称。
- key参数：表示产生事件的键。
- dbid参数：表示数据库ID。

当Redis命令需发送数据库通知时，该命令实现函数会调用notifyKeyspaceEvent函数，服务器根据配置文件设置向客户端发送数据库通知。


### 第5章 Redis数据库
通过对前面章节的学习，我们熟悉了Redis数据库的键命令，本章将为大家讲解Redis数据库。使用前面章节讲到的命令来操作Redis数据库，比如，切换Redis数据库，Redis数据库中的键操作（添加、更新、删除、取值等），以及Redis数据库高版本（Redis 2.8）中的通知功能等。

#### 5.1 Redis数据库切换
Redis数据库保存在Redis服务器状态server.h/redisServer结构的db数组中。这个db数组中的每个元素都是一个server.h/redisDb结构，而每个redisDb结构就代表一个Redis数据库。

Redis服务器状态有一个dbnum属性，该属性用于在启动Redis服务器时，决定创建多少个数据库。Redis服务器配置中的database选项决定了dbnum属性的值。在默认情况下，dbnum属性的值为16，也就是在启动Redis服务器时，会默认创建16（0~15号）个数据库，如图5.1所示。

**图5.1 Redis数据库**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__...
          |__ db[14]
          |__ db[15]
    |
    |__ dbnum 16
```

我们在操作数据库时，需要选择具体操作哪个数据库。每个Redis客户端都有其对应的目标数据库，在利用Redis客户端操作数据库时，目标数据库就是操作对象。通常，我们在操作Redis数据库时，默认操作的是Redis的0号数据库。如果我们想操作其他数据库，则可以使用SELECT命令来切换数据库，比如切换到4号数据库，操作如图5.2所示。

**图5.2 使用SELECT命令切换数据库**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__ db[3]
          |__ db[4]
          |__...
          |__ db[15]
    |
    |__ dbnum 16
redisClient
    |
    |__ db
          |__  (通过SELECT 4切换指向db[4])
```

在Redis服务器内部，有一个db属性，这个属性是客户端状态redisClient中的属性，它是一个指向redisDb结构的指针，用于记录当前客户端操作的目标数据库。redisClient.db指针指向redisServer.db数组中的某个元素，这个被指向的元素就是客户端的目标数据库。我们在启动Redis服务器与客户端时，默认的目标数据库是0号数据库，这个客户端指向的也是0号数据库，此时客户端与服务器状态之间的关系如图5.3所示。

**图5.3 Redis客户端与服务器状态之间的关系**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__ db[3]
          |__...
          |__ db[15]
    |
    |__ dbnum 16
redisClient
    |
    |__ db
          |__ (默认指向0号数据库)
```

命令SELECT的实现原理：我们在操作Redis数据库时，可以根据需要使用SELECT index命令来切换当前操作的Redis数据库，这个index就相当于redisServer.db数组的下标，这个下标从0开始，它也是redisClient.db指针的索引值，索引值从0开始。通过指定index的值，也就是修改redisClient.db指针，来指向服务器中的不同数据库，达到切换数据库的目的。

#### 5.2 Redis数据库中的键操作
Redis是一个键值对数据库，在Redis服务器中使用server.h/redisDb结构来表示Redis数据库。在redisDb结构中存储了Redis数据库中的所有键值对，它就是dict字典，这个字典就是Redis的键空间。这个键空间存储了Redis数据库中的键和其对应的值，每个键就是一个字符串对象，而每个键所对应的值可以是字符串对象、集合对象、有序集合对象、列表对象或哈希表对象。

我们在操作Redis数据库时，比如，执行添加键、修改键、删除键或取键值操作，其实就是在操作Redis的键空间，这个键空间针对数据库的所有操作。下面我们来逐一说明。

##### 5.2.1 添加键
向Redis数据库中添加新键值对，其实就是将一个新键值对插入键空间字典里面，这个键是一个字符串对象，而这个值可以是Redis数据类型中的任意一种。比如，当前数据库是一个空数据库，我们向数据库中添加两个新的键值对，命令如下：
```
127.0.0.1:6379> SET name "liuhefei"
OK
127.0.0.1:6379> SET age 18
OK
```
再比如，执行如下命令来向键空间中添加新值：
```
127.0.0.1:6379> HSET chain city "北京"
OK
127.0.0.1:6379> HSET chain city "上海"
OK
```
在Redis中，除可以使用SET命令向Redis键空间中添加新的键值对以外，还有许多命令也可以实现添加新的键值对，读者可以参考第3章中的相关命令操作。

##### 5.2.2 修改键
在Redis中，修改Redis的键，其实就是对键空间里面的键所对应的值进行修改，这个值可以是Redis数据类型中的任意一种，因此对这个值的修改命令也会不同。

比如，之前我们已经向数据库中添加了一个键name，我们来修改它的值，执行以下命令：
```
127.0.0.1:6379>SET name "Hello redis"
OK
```
执行命令之后，name键所对应的由最初的“liuhefei”修改为“Hello redis”。

针对Redis键值对的值的数据类型不同，会有相对应的修改键命令，在此不再赘述，请读者参考第3章中的相关命令操作。

除可以修改Redis键所对应的值之外，还可以修改这个键的时间（生存时间或过期时间）。Redis有4个命令可以设置键的生存时间，分别是EXPIRE、PEXPIRE、EXPIREAT及PEXPIREAT。

使用EXPIRE命令来修改Redis键的生存时间，它以秒为单位；或者使用PEXPIRE命令来修改Redis键的生存时间，它以毫秒为单位。在经过指定的秒数或毫秒数（倒计时）之后，这个键对应的生存时间变为0，此时服务器会自动删除生存时间设置为0的键。如果要为一个字符串类型的键值对设置过期时间，则可以在使用SET命令设置一个字符串键的同时，为这个键设置过期时间。操作如下：
```
127.0.0.1:6379>SET height 170
OK
127.0.0.1:6379>EXPIRE height 10  //设置height键的生存时间为10秒
(integer) 1
127.0.0.1:6379>GET height  //10秒之内height键还存在
"170"
127.0.0.1:6379>GET height  //10秒之后，height键的生存时间为0，被删除
(nil)
```
同理，PEXPIRE命令也是如此。

与EXPIRE或PEXPIRE命令相似的还有EXPIREAT或PEXPIREAT命令，这两个命令分别以秒或毫秒精度来给数据库中的某个键设置过期时间，这个过期时间是UNIX时间戳，我们可以通过TIME命令来查看。当这个键的过期时间为0时，服务器会自动删除它。操作如下：
```
127.0.0.1:6379>SET width 100
OK
127.0.0.1:6379>EXPIREAT width 1527342900
(integer) 1
127.0.0.1:6379>TIME
1) "1527342821"
2) "504782"
127.0.0.1:6379>GET width  //UNIX时间戳之前
"170"
127.0.0.1:6379>TIME
1) "1527342912"
2) "657996"
127.0.0.1:6379>GET width
(nil)
```
另外，也可以使用TTL或PTTL命令来接收一个设置了生存时间的键，用于获取这个键的剩余生存时间，返回的剩余生存时间值就是距离服务器删除这个键的剩余时间。操作如下：
```
127.0.0.1:6379> SET key1 value1
OK
127.0.0.1:6379>EXPIRE key1 1000
(integer) 1
127.0.0.1:6379>TTL key1
(integer) 6379
```
上面的命令设置了很多键的生存时间，那么这些键的生存时间保存在哪里呢？

在redisDb结构中，有一个专门用来保存数据库中所有键的过期时间的字典，这个字典就是expires字典，它被称为过期字典。

过期字典的键是一个指针，它指向键空间中的某个对象；而过期字典的值是一个long类型的整数，这个整数是一个毫秒精度的UNIX时间戳，即键的过期时间。

使用PERSIST命令来删除一个键的生存时间，操作如下：
```
127.0.0.1:6379>PEXPIREAT sms 1527349000  //设置sms键的生存时间
OK
127.0.0.1:6379>TTL sms  //获取sms键的剩余生存时间
(integer) 13876
127.0.0.1:6379>PERSIST sms  //删除sms键的生存时间
(integer) 1
127.0.0.1:6379>TTL sms  //返回-1，表示已经成功删除sms键的生存时间
(integer) -1
```

我们常常使用TTL命令来返回一个键的剩余生存时间，以秒为单位；也可以使用PTTL命令来返回一个键的剩余生存时间，以毫秒为单位。

##### 5.2.3 删除键
如果数据库中的一个键不需要了，我们就会选择删除它。其实删除一个键也就是删除这个键所对应的键值对对象。我们使用DEL命令来删除一个键，操作如下：
```
127.0.0.1:6379>DEL name
(integer) 1  //表示删除成功
```

在实际应用中，针对过期的键，也需要删除。面对一个过期的键，有以下3种删除方式：
1. **定时删除**：在为一个键设置过期时间的同时为它设置一个定时器（Timer），当这个键的过期时间到来时，这个定时器会立即执行对键的删除操作。这种删除键的方式比较好，利用定时器定时删除键可以保证过期的键不会长时间存留在数据库中，从而释放过期的键所占用的内存。定时删除键的缺点是：它会占用CPU的大量时间，如果过期的键比较多，同时CPU又比较繁忙，则会对服务器的吞吐量和响应时间产生很大影响，从而影响服务器的性能。
2. **惰性删除**：对数据库中的键持有放任态度，但是每次从键空间中获取键时，都会对获取的键进行检查，判断它是否过期，过期就删除它，没有过期就返回它。惰性删除方式不会像定时删除和定期删除方式那样及时删除过期键，只有当取出键时，它才会检查这个键是否过期，来决定是否删除这个键，并且删除的目标键就是用户正在操作的这个键。它不会在删除其他无关的过期键上消耗任何CPU时间。

惰性删除方式虽然不消耗CPU时间，但是它不会定时、定期地删除过期的键，因此过期的键会长期存留在内存中，就会占用大量的内存，这也是惰性删除过期的键的最大缺点。
3. **定期删除**：采用算法实现每隔一段时间就对数据库进行一次检查，筛选出过期的键进而删除。在算法中可以设置检查多少个数据库，每检查一次具体删除多少过期的键。定期删除方式是定时删除和惰性删除的折中方案，它通过算法实现每隔一段时间检查数据库，筛选过期的键，然后删除，从而减少了对CPU时间的占用，同时对过期键的及时删除，使得过期键占用的内存得以释放。

其实，Redis服务器只采用了惰性删除和定期删除两种方式，这两种方式的实现如下：
- **惰性删除方式的实现**：Redis的db.c/expireIfNeeded函数实现了对过期键的惰性删除。Redis的所有读/写命令在读/写数据库之前都会调用expireIfNeeded函数对输入键进行检查。常见的读/写命令有SET、SADD、LRANGE、HGET、KEYS等。如果输入的键已经过期，那么这个过期的键会被expireIfNeeded函数删除。如果输入的键没有过期，那么expireIfNeeded函数不做任何处理。
- **定期删除方式的实现**：Redis的server.c/activeExpireCycle函数实现了对过期键的定期删除。前面说过，定期删除过期的键是采用算法实现，算法会设置周期时间，每当Redis服务器周期性操作server.c/serverCron函数时，它会调用activeExpireCycle函数在规定的时间内开始遍历各个数据库，从数据库的过期（expires）字典中随机筛选出部分过期的键，随后删除。

##### 5.2.4 取键值
结合实际生活中的例子，我们把钱存到银行，后期还是会取出来用的。同样，我们把键值对存入数据库，也会取出来用。对一个数据库中的键取值，其实就是从数据库的键空间中取出这个键所对应的键值对对象。针对Redis数据库的不同数据类型，有不同的取键值命令。

比如，取字符串类型的键值，使用GET命令，操作如下：
```
127.0.0.1:6379>SET news 你好! 我是redis!
OK
127.0.0.1:6379>GET news
"你好! 我是redis!"
```

关于其他Redis数据类型的取值方式，读者可以参考本书第3章中的相关命令操作，在此不再过多讲述。

#### 5.3 Redis数据库通知
在Redis 2.8版本以后，新增加了数据库通知功能。数据库通知功能实现了让客户端通过订阅指定的消息频道或消息模式，来动态获取数据库中键的变化，以及数据库中命令的执行情况。

##### 5.3.1 数据库通知分类
1. **键空间通知**：键空间通知主要关注某个键执行了什么命令。下面的例子就是键空间通知。

我们使用SUBSCRIBE命令来获取1号数据库中针对message键执行的所有命令，操作如下：
```
127.0.0.1:6379>SUBSCRIBE __keyspace@1__:message
Reading messages... (press Ctrl-C to quit)
1) "subscribe"  #返回值的类型，表示消息订阅成功
2) "__keyspace@1__:message"  #订阅的消息频道名称
3) (integer) 1  #表示已经订阅的频道数量
1) "message"
2) "__keyspace@1__:message"
3) "sadd"  #执行了sadd命令
1) "message"
2) "__keyspace@1__:news"
3) "srem"  #执行了srem命令
```
2. **键事件通知**：键事件通知主要关注某个命令被哪些键执行了。下面的例子就是键事件通知。

我们使用SUBSCRIBE命令来查看1号数据库中SET命令被哪些键执行了，操作如下：
```
127.0.0.1:6379>SUBSCRIBE __keyevent@1__:set
Reading messages... (press Ctrl-C to quit)
1) "subscribe"  #消息订阅成功
2) "__keyevent@1__:set"
3) (integer) 1
1) "message"
2) "set"
3) "name"  #键name执行了SET命令
```

键空间通知使得客户端可以通过订阅频道或模式来接收那些以某种方式修改了Redis数据集的事件，通过Redis的消息订阅发布功能实现事件的分发。因此，只要是支持消息订阅发布功能的客户端，都可以在不修改任何内容的情况下使用键空间通知功能。

目前，Redis的消息订阅发布功能采取的是发送即忘的策略。当订阅事件的客户端断线时，所有在线期间分发给它的事件都会丢失。

键空间通知针对每个修改数据库的操作，都会发送两种不同类型的事件。比如，在1号数据库中键name执行了SET命令，系统会发送两条消息，相当于执行了PUBLISH命令。
```
PUBLISH __keyspace@1__:name
PUBLISH __keyevent@1__:set name
```
频道`__keyspace@1__:name`可以接收1号数据库中所有修改name键的事件；而频道`__keyevent@1__:set`则可以接收1号数据库中所有执行SET命令的键。

键空间通知以keyspace为前缀；键事件通知以keyevent为前缀。

在执行SET name命令时：
- 键空间频道的订阅者将接收到被执行的事件的
名字，这里为SET。
- 键事件频道的订阅者将接收到被执行事件的键的名字，这里为name。

在默认情况下，数据库通知功能是关闭的，因为它会占用CPU资源。

在实际应用中，如果需要开启数据库通知功能，则可以通过CONFIG SET命令来直接开启或关闭键空间通知功能；或者修改Redis的配置文件redis.conf中notify - keyspace - events参数的值。

其中，notify - keyspace - events参数的值可以是以下字符的任意组合，它们规定了服务器会发送哪些类型的通知。
- **K**：表示键空间通知，所有键空间通知都以`__keyspace@<db>__`为前缀。
- **E**：表示键事件通知，所有键事件通知都以`__keyevent@<db>__`为前缀。
- **g**：表示DEL、EXPIRE、RENAME等类型无关的通知命令的通知。
- **$**：表示字符串命令的通知。
- **h**：表示哈希命令的通知。
- **l**：表示列表命令的通知。
- **z**：表示有序集合命令的通知。
- **s**：表示集合命令的通知。
- **x**：表示过期事件，当有过期的键被删除时触发发送通知。
- **e**：表示驱逐事件，当有键因为maxmemory政策而被删除时触发发送通知。
- **A**：表示g$hlzsxe的别名。

注意：在为notify - keyspace - events参数设置值时，至少要有一个K或E，否则无论其余的参数值是什么，都不会发送任何通知。

常见的参数值组合形式有以下几种：
- 将参数值设置为AKE，表示所有类型的通知都会被发送。
- 将参数值设置为AK，表示让服务器发送所有类型的键空间通知。
- 将参数值设置为AE，表示让服务器发送所有类型的键事件通知。
- 将参数值设置为KS，表示让服务器只发送与字符串键相关的键空间通知。其他类型的也是如此。
- 将参数值设置为El，表示让服务器只发送与列表键有关的键事件通知。其他类型的也是如此。

关于notify - keyspace - events参数更多的参数值组合，在这里就不多说了，请读者自行查阅与实践。

##### 5.3.2 数据库通知的实现原理
数据库通知的发送功能是由notify.c/notifyKeyspaceEvent函数实现的，这个函数的定义如下：
```c
void notifyKeyspaceEvent(int type, char *event, robj *key, int dbid);
```
- **type参数**：表示要发送的通知类型，程序会按照这个值来判断通知是否就是服务器配置的notify - keyspace - events参数所设定的通知类型，然后决定是否发送通知。
- **event参数**：表示发送事件的名称。
- **key参数**：表示产生事件的键，也就是与该发送事件相关的键。
- **dbid参数**：表示数据库ID，也就是产生事件的数据库编号。

函数notifyKeyspaceEvent会根据它的参数来生成事件通知的内容，以及接收事件通知的频道名。

当一个Redis命令需要发送数据库通知的时候，该命令的实现函数就会调用notifyKeyspaceEvent函数，来实现发送通知功能。

当Redis命令对数据库进行修改之后，服务器就会根据相关配置文件的设置来向客户端发送数据库通知。

至此，Redis的相关基础功能我们已经学习完了，后面将为读者讲述Redis的相关高级功能。 



