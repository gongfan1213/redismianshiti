### 第5章 Redis数据库
通过对前面章节的学习，我们熟悉了Redis数据库的键命令，本章将为大家讲解Redis数据库。使用前面章节讲到的命令来操作Redis数据库，比如，切换Redis数据库，Redis数据库中的键操作（添加、更新、删除、取值等），以及Redis数据库高版本（Redis 2.8）中的通知功能等。

#### 5.1 Redis数据库切换
Redis数据库保存在Redis服务器状态server.h/redisServer结构的db数组中。这个db数组中的每个元素都是一个server.h/redisDb结构，而每个redisDb结构就代表一个Redis数据库。

Redis服务器状态有一个dbnum属性，该属性用于在启动Redis服务器时，决定创建多少个数据库。Redis服务器配置中的database选项决定了dbnum属性的值。在默认情况下，dbnum属性的值为16，也就是在启动Redis服务器时，会默认创建16（0~15号）个数据库，如图5.1所示。

![image](https://github.com/user-attachments/assets/067e29b0-99d2-494a-8301-f6739451cc39)


**图5.1 Redis数据库**

```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__...
          |__ db[14]
          |__ db[15]
    |
    |__ dbnum 16
```

我们在操作数据库时，需要选择具体操作哪个数据库。每个Redis客户端都有其对应的目标数据库，在利用Redis客户端操作数据库时，目标数据库就是操作对象。通常，我们在操作Redis数据库时，默认操作的是Redis的0号数据库。如果我们想操作其他数据库，则可以使用SELECT命令来切换数据库，比如切换到4号数据库，操作如图5.2所示。

![image](https://github.com/user-attachments/assets/c41cf5ca-1fdc-4b00-a27a-79437840c6a6)


**图5.2 使用SELECT命令切换数据库**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__ db[3]
          |__ db[4]
          |__...
          |__ db[15]
    |
    |__ dbnum 16
redisClient
    |
    |__ db
          |__  (通过SELECT 4切换指向db[4])
```

在Redis服务器内部，有一个db属性，这个属性是客户端状态redisClient中的属性，它是一个指向redisDb结构的指针，用于记录当前客户端操作的目标数据库。redisClient.db指针指向redisServer.db数组中的某个元素，这个被指向的元素就是客户端的目标数据库。我们在启动Redis服务器与客户端时，默认的目标数据库是0号数据库，这个客户端指向的也是0号数据库，此时客户端与服务器状态之间的关系如图5.3所示。

![image](https://github.com/user-attachments/assets/469509e1-b53f-4bb6-9cf5-20d18727b9b3)


**图5.3 Redis客户端与服务器状态之间的关系**
```
redisServer
    |
    |__ db
          |__ db[0]
          |__ db[1]
          |__ db[2]
          |__ db[3]
          |__...
          |__ db[15]
    |
    |__ dbnum 16
redisClient
    |
    |__ db
          |__ (默认指向0号数据库)
```

命令SELECT的实现原理：我们在操作Redis数据库时，可以根据需要使用SELECT index命令来切换当前操作的Redis数据库，这个index就相当于redisServer.db数组的下标，这个下标从0开始，它也是redisClient.db指针的索引值，索引值从0开始。通过指定index的值，也就是修改redisClient.db指针，来指向服务器中的不同数据库，达到切换数据库的目的。

#### 5.2 Redis数据库中的键操作
Redis是一个键值对数据库，在Redis服务器中使用server.h/redisDb结构来表示Redis数据库。在redisDb结构中存储了Redis数据库中的所有键值对，它就是dict字典，这个字典就是Redis的键空间。这个键空间存储了Redis数据库中的键和其对应的值，每个键就是一个字符串对象，而每个键所对应的值可以是字符串对象、集合对象、有序集合对象、列表对象或哈希表对象。

我们在操作Redis数据库时，比如，执行添加键、修改键、删除键或取键值操作，其实就是在操作Redis的键空间，这个键空间针对数据库的所有操作。下面我们来逐一说明。

##### 5.2.1 添加键
向Redis数据库中添加新键值对，其实就是将一个新键值对插入键空间字典里面，这个键是一个字符串对象，而这个值可以是Redis数据类型中的任意一种。比如，当前数据库是一个空数据库，我们向数据库中添加两个新的键值对，命令如下：
```
127.0.0.1:6379> SET name "liuhefei"
OK
127.0.0.1:6379> SET age 18
OK
```
再比如，执行如下命令来向键空间中添加新值：
```
127.0.0.1:6379> HSET chain city "北京"
OK
127.0.0.1:6379> HSET chain city "上海"
OK
```
在Redis中，除可以使用SET命令向Redis键空间中添加新的键值对以外，还有许多命令也可以实现添加新的键值对，读者可以参考第3章中的相关命令操作。

##### 5.2.2 修改键
在Redis中，修改Redis的键，其实就是对键空间里面的键所对应的值进行修改，这个值可以是Redis数据类型中的任意一种，因此对这个值的修改命令也会不同。

比如，之前我们已经向数据库中添加了一个键name，我们来修改它的值，执行以下命令：
```
127.0.0.1:6379>SET name "Hello redis"
OK
```
执行命令之后，name键所对应的由最初的“liuhefei”修改为“Hello redis”。

针对Redis键值对的值的数据类型不同，会有相对应的修改键命令，在此不再赘述，请读者参考第3章中的相关命令操作。

除可以修改Redis键所对应的值之外，还可以修改这个键的时间（生存时间或过期时间）。Redis有4个命令可以设置键的生存时间，分别是EXPIRE、PEXPIRE、EXPIREAT及PEXPIREAT。

使用EXPIRE命令来修改Redis键的生存时间，它以秒为单位；或者使用PEXPIRE命令来修改Redis键的生存时间，它以毫秒为单位。在经过指定的秒数或毫秒数（倒计时）之后，这个键对应的生存时间变为0，此时服务器会自动删除生存时间设置为0的键。如果要为一个字符串类型的键值对设置过期时间，则可以在使用SET命令设置一个字符串键的同时，为这个键设置过期时间。操作如下：
```
127.0.0.1:6379>SET height 170
OK
127.0.0.1:6379>EXPIRE height 10  //设置height键的生存时间为10秒
(integer) 1
127.0.0.1:6379>GET height  //10秒之内height键还存在
"170"
127.0.0.1:6379>GET height  //10秒之后，height键的生存时间为0，被删除
(nil)
```
同理，PEXPIRE命令也是如此。

与EXPIRE或PEXPIRE命令相似的还有EXPIREAT或PEXPIREAT命令，这两个命令分别以秒或毫秒精度来给数据库中的某个键设置过期时间，这个过期时间是UNIX时间戳，我们可以通过TIME命令来查看。当这个键的过期时间为0时，服务器会自动删除它。操作如下：
```
127.0.0.1:6379>SET width 100
OK
127.0.0.1:6379>EXPIREAT width 1527342900
(integer) 1
127.0.0.1:6379>TIME
1) "1527342821"
2) "504782"
127.0.0.1:6379>GET width  //UNIX时间戳之前
"170"
127.0.0.1:6379>TIME
1) "1527342912"
2) "657996"
127.0.0.1:6379>GET width
(nil)
```
另外，也可以使用TTL或PTTL命令来接收一个设置了生存时间的键，用于获取这个键的剩余生存时间，返回的剩余生存时间值就是距离服务器删除这个键的剩余时间。操作如下：
```
127.0.0.1:6379> SET key1 value1
OK
127.0.0.1:6379>EXPIRE key1 1000
(integer) 1
127.0.0.1:6379>TTL key1
(integer) 6379
```
上面的命令设置了很多键的生存时间，那么这些键的生存时间保存在哪里呢？ 


### 第5章 Redis数据库
通过对前面章节的学习，我们熟悉了Redis数据库的键命令，本章将为大家讲解Redis数据库。使用前面章节讲到的命令来操作Redis数据库，比如，切换Redis数据库，Redis数据库中的键操作（添加、更新、删除、取值等），以及Redis数据库高版本（Redis 2.8）中的通知功能等。

#### 5.1 Redis数据库切换
Redis数据库保存在Redis服务器状态server.h/redisServer结构的db数组中。这个db数组中的每个元素都是一个server.h/redisDb结构，而每个redisDb结构就代表一个Redis数据库。

Redis服务器状态有一个dbnum属性，该属性用于在启动Redis服务器时，决定创建多少个数据库。Redis服务器配置中的database选项决定了dbnum属性的值。在默认情况下，dbnum属性的值为16，也就是在启动Redis服务器时，会默认创建16（0 - 15号）个数据库。

我们在操作数据库时，需要选择具体操作哪个数据库。每个Redis客户端都有其对应的目标数据库，在利用Redis客户端操作数据库时，目标数据库就是操作对象。通常，我们在操作Redis数据库时，默认操作的是Redis的0号数据库。如果我们想操作其他数据库，则可以使用SELECT命令来切换数据库。

在Redis服务器内部，客户端状态redisClient中的db属性，是一个指向redisDb结构的指针，用于记录当前客户端操作的目标数据库。命令SELECT的实现原理是通过修改redisClient.db指针，来指向服务器中的不同数据库，达到切换数据库的目的。

#### 5.2 Redis数据库中的键操作
Redis是一个键值对数据库，在redisDb结构中存储了Redis数据库中的所有键值对，键空间存储了数据库中的键和其对应的值，值可以是多种对象类型。

##### 5.2.1 添加键
向Redis数据库中添加新键值对，即将新键值对插入键空间字典。可以使用SET、HSET等命令添加键值对，还有许多命令可实现添加操作。

示例：
```
127.0.0.1:6379> SET name "liuhefei"
OK
127.0.0.1:6379> SET age 18
OK
127.0.0.1:6379> HSET chain city "北京"
OK
127.0.0.1:6379> HSET chain city "上海"
OK
```

##### 5.2.2 修改键
修改Redis的键，即对键空间里键对应的值进行修改。值类型不同，修改命令也不同。除修改值外，还可修改键的生存时间或过期时间，有EXPIRE、PEXPIRE、EXPIREAT、PEXPIREAT等命令，也可使用TTL或PTTL命令获取键的剩余生存时间。

示例：
```
127.0.0.1:6379>SET name "Hello redis"
OK
127.0.0.1:6379>SET height 170
OK
127.0.0.1:6379>EXPIRE height 10  //设置height键的生存时间为10秒
(integer) 1
127.0.0.1:6379>GET height  //10秒之内height键还存在
"170"
127.0.0.1:6379>GET height  //10秒之后，height键的生存时间为0，被删除
(nil)
127.0.0.1:6379>SET width 100
OK
127.0.0.1:6379>EXPIREAT width 1527342900
(integer) 1
127.0.0.1:6379>TIME
1) "1527342821"
2) "504782"
127.0.0.1:6379>GET width  //UNIX时间戳之前
"170"
127.0.0.1:6379>TIME
1) "1527342912"
2) "657996"
127.0.0.1:6379>GET width
(nil)
127.0.0.1:6379> SET key1 value1
OK
127.0.0.1:6379>EXPIRE key1 1000
(integer) 1
127.0.0.1:6379>TTL key1
(integer) 6379
```
还可使用PERSIST命令删除键的生存时间。

示例：
```
127.0.0.1:6379>PEXPIREAT sms 1527349000  //设置sms键的生存时间
OK
127.0.0.1:6379>TTL sms  //获取sms键的剩余生存时间
(integer) 13876
127.0.0.1:6379>PERSIST sms  //删除sms键的生存时间
(integer) 1
127.0.0.1:6379>TTL sms  //返回-1，表示已经成功删除sms键的生存时间
(integer) -1
```

##### 5.2.3 删除键
使用DEL命令删除一个键。对于过期的键，有定时删除、惰性删除、定期删除三种删除方式：
- **定时删除**：在设置过期时间的同时设置定时器，过期时立即删除。优点是能及时释放内存，缺点是占用CPU资源，影响服务器性能。
- **惰性删除**：每次从键空间获取键时检查是否过期，过期则删除，不过期则返回。不主动消耗CPU检查无关过期键，但过期键会长期占用内存。
- **定期删除**：每隔一段时间对数据库进行检查，筛选并删除过期键，是定时删除和惰性删除的折中方案，减少CPU占用，及时释放过期键内存。

Redis服务器采用惰性删除和定期删除方式。惰性删除由db.c/expireIfNeeded函数实现，Redis读写命令会调用该函数检查输入键；定期删除由server.c/activeExpireCycle函数实现，Redis服务器周期性操作会调用此函数遍历数据库删除过期键。

示例：
```
127.0.0.1:6379>DEL name
(integer) 1
```

##### 5.2.4 取键值
从数据库键空间取出键对应的值，针对不同数据类型有不同取键值命令，取字符串类型键值用GET命令。

示例：
```
127.0.0.1:6379>SET news 你好! 我是redis!
OK
127.0.0.1:6379>GET news
"你好! 我是redis!"
```

#### 5.3 Redis数据库通知
Redis 2.8版本后新增数据库通知功能，可让客户端订阅消息频道或模式，动态获取数据库中键的变化及命令执行情况。

##### 5.3.1 数据库通知分类
- **键空间通知**：关注某个键执行了什么命令。使用SUBSCRIBE命令获取，如`127.0.0.1:6379>SUBSCRIBE __keyspace@1__:message` ，可接收对message键执行命令的通知。
- **键事件通知**：关注某个命令被哪些键执行。使用SUBSCRIBE命令，如`127.0.0.1:6379>SUBSCRIBE __keyevent@1__:set` ，可查看1号数据库中SET命令被哪些键执行。

键空间通知以`__keyspace@<db>__`为前缀，键事件通知以`__keyevent@<db>__`为前缀。默认数据库通知功能关闭，可通过CONFIG SET命令或修改redis.conf中notify - keyspace - events参数开启或关闭。该参数值规定服务器发送通知类型，常见参数值组合如：
- AKE：表示所有类型的通知都会被发送。
- AK：表示让服务器发送所有类型的键空间通知。
- AE：表示让服务器发送所有类型的键事件通知。
- KS：表示让服务器只发送与字符串键相关的键空间通知。
- El：表示让服务器只发送与列表键有关的键事件通知。 

##### 5.3.2 数据库通知的实现原理
数据库通知发送功能由notify.c/notifyKeyspaceEvent函数实现，函数定义为`void notifyKeyspaceEvent(int type, char *event, robj *key, int dbid);` ，各参数含义如下：
- type参数：表示要发送的通知类型，程序依此判断是否为服务器配置的通知类型，决定是否发送通知。
- event参数：表示发送事件的名称。
- key参数：表示产生事件的键。
- dbid参数：表示数据库ID。

当Redis命令需发送数据库通知时，该命令实现函数会调用notifyKeyspaceEvent函数，服务器根据配置文件设置向客户端发送数据库通知。 
